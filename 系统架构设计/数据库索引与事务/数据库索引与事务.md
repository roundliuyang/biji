# 数据库索引与事务



## 为什么要了解数据库索引和事务？

系统设计最核心的内容就是数据库设计，没有掌握数据库基础知识点的话就无法更好地进行系统设计。

![1664245057391](数据库索引与事务.assets/1664245057391.png)



在面试的过程中，面试官可能会直接问数据库的问题

- B+Tree 的原理是什么？
- InnoDB 和 MyISAM 的区别？ 
- 什么是事务的隔离级别？

如果不理解基础知识，就很难理解后面的实战设计题。

## 索引  Index

索引是一种特殊的数据库结构，由数据表中的一列或多列组成，可以用来快速查询数据表中有某一特定值的记录。



### MySQL 中的索引

索引（Index）是帮助MySQL高效获取数据的数据结构。

数据库查询是数据库的最主要功能之一

![1664245726579](数据库索引与事务.assets/1664245726579.png)



#### 一种可能的索引方式

![1664246509633](数据库索引与事务.assets/1664246509633.png)

#### 二叉查找树中存在的问题

索引以索引文件的形式存储在磁盘上。这样导致索引查找过程中就要产生磁盘I/O消耗。相对于内存存取，I/O存取的消耗要高几个数量级。

评价一个数据结构作为索引的优劣最重要的指标就是在查找过程中磁盘I/O操作的次数。换句话说，索引的结构组织要尽量减少查找过程中磁盘I/O的存取次数。



#### MySQL 索引的实现 - B+树

![1664247526028](数据库索引与事务.assets/1664247526028.png)





#### MySQL 索引的实现 - 带顺序指针的B+树

![1664248291783](数据库索引与事务.assets/1664248291783.png)



#### MySQL 索引与数据的结构

![1664248443017](数据库索引与事务.assets/1664248443017.png)

#### MyISAM 中索引与数据的结构（非聚集索引 Nonclustered Index）

![1664248833194](数据库索引与事务.assets/1664248833194.png)

![1664248715797](数据库索引与事务.assets/1664248715797.png)

#### InnoDB 中索引与数据的结构（聚集索引 Clustered Index）

![1664249465278](数据库索引与事务.assets/1664249465278.png)

![1664249920106](数据库索引与事务.assets/1664249920106.png)

#### 两种存储引擎索引比较

![1664251765355](数据库索引与事务.assets/1664251765355.png)



#### 联合索引(Composite Index)和多列单索引

![1664259488788](数据库索引与事务.assets/1664259488788.png)



#### InnoDB 主键最佳实践

![1664260058502](数据库索引与事务.assets/1664260058502.png)

#### 索引带来的问题和建立原则

![1664260228237](数据库索引与事务.assets/1664260228237.png)

##### 哪些列不要建索引

1. 不太会查询到的列
2. 本身没有顺序，或者特别长的列。如，「地址」。
3. 表记录比较少，就不用建索引了，直接全表扫描。如，「班级同学」表。（千这个数量级都不用加索引）
4. 选择性低，即重复率高，可枚举的(Enumerable)列。如「性别」。



### 开放式实践题

![1664263562564](数据库索引与事务.assets/1664263562564.png)



1.用自增id做主键（与业务属性无关）

2.姓+名建立联合索引

3.身份证号唯一索引

其它没必要



## 事务 Transaction

当多个用户访问同一数据时，一个用户在更改数据的过程中可能有其它用户同时发起更改请求，为保证数据的一致性状态，MySQL 引入了事务。



### 什么是事务？

![1664260852320](数据库索引与事务.assets/1664260852320.png)



### 事务的特性 - ACID

![1664260963351](数据库索引与事务.assets/1664260963351.png)

### 事务的特性 - 一致性保障

![1664261443252](数据库索引与事务.assets/1664261443252.png)

### 事务并发控制

隔离性(Isolation) 和 一致性(consistency) 保障

#### 并发问题

当多个进程(Process)或线程(Thread)并发地操作数据库时，有 3 种冲突类型：

读 - 读 ：不会引发任何并发(Concurrent)问题。

读 - 写 ：有隔离性(Isolation)的问题，可能读到不正确的数据。

写 - 写 ：有隔离性的问题，可能丢失掉已经更新的内容。



#### 事务的隔离性和隔离级别(Isolation Levels)

![1664262011869](数据库索引与事务.assets/1664262011869.png)

#### 并发问题 - 脏写(Dirty Writes)问题

不会被允许出现的

![1664262319196](数据库索引与事务.assets/1664262319196.png)

#### 并发问题 - 脏读(Dirty Reads)问题

![1664262860779](数据库索引与事务.assets/1664262860779.png)



#### 并发问题 - 不可重复读(Non-repeatable Reads)问题

![1664263008485](数据库索引与事务.assets/1664263008485.png)



#### 并发问题 - 幻读(Phantom Reads)问题

![1664263129961](数据库索引与事务.assets/1664263129961.png)



#### 事务的隔离性和隔离级别(Isolation Levels)

![1664263311016](数据库索引与事务.assets/1664263311016.png)





### 并发控制技术

**乐观并发控制(Optimistic Concurrency Control)**

对于并发执行可能冲突的操作，假定其并不会真的冲突，允许并发执行。直到真正发生冲突时才去解决冲突，比如让事务回滚。

**悲观并发控制(Pessimistic Concurrency Control)**

对于并发执行可能冲突的操作，假定其必定发生冲突，不允许并发执行。通过让事务等待或者终止的方式使并行的操作串行化(Serializable)执行。



#### 加锁(Lock)

对于可能造成冲突的任何并发操作，比如读-写、写-读、写-写、通过加锁使它们互斥执行。

**共享锁 Shared Locks（读锁）**

**如果 事务T 对 数据A 加上共享锁后，**则其他事务只能对 A 再加共享锁，不能加排他锁。获准共享锁的事务只能读数据，不能修改数据。也叫读锁。

**排他锁 Exclusive lock（写锁）**

**如果 事务T 对 数据A 加上排他锁后**，则其他事务不能再对 A 加任何类型的锁。获准排他锁的事务既能读数据，又能修改数据。也叫写锁。

![1664264078644](数据库索引与事务.assets/1664264078644.png)



#### 时间戳(Timestamp)控制



对于可能造成冲突的任何并发操作，基于时间戳排序规则，选定某事务继续执行，其他事务回滚(Rollback)。

**事务时间戳**

每个事务开始时赋予其一个时间戳。可以是系统时钟，也可以是自增的计数器值。事务回滚时会赋予其一个新的时间戳。先开始的事务时间戳小于后开始事务的时间戳。标记为 ts(T)

**数据项时间戳**

记录读写该数据的最新事务的时间戳标记为 r_ts(X), w_ts(X)

![1664264356903](数据库索引与事务.assets/1664264356903.png)



#### 有效性检查

![1664264557944](数据库索引与事务.assets/1664264557944.png)



### 数据库故障恢复

原子性(Atomicity)、持久性(Durability) 和 一致性(Consistency) 保障

![1664264775605](数据库索引与事务.assets/1664264775605.png)

#### 数据库的延迟修改

![1664264996584](数据库索引与事务.assets/1664264996584.png)

#### 事务执行过程中的故障

**立即修改**

数据库在事务提交前出现故障，但是事务的部分修改已经写入磁盘中。这破坏了事务的**原子性(Atomicity)。**

**延迟修改**

数据库在事务提交后出现故障，但数据还在内存缓冲区(Buffer)中，未写入磁盘。系统恢复时将丢失此次已提交的修改。这破坏了事务的**持久性(Durability)。**



#### 日志类别

![1664265112609](数据库索引与事务.assets/1664265112609.png)

## 事务总结

![1664265147374](数据库索引与事务.assets/1664265147374.png)



## 分布式事务

![1664265255930](数据库索引与事务.assets/1664265255930.png)



